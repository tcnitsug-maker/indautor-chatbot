<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrativo - INDARELÃN</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="/admin-app/css/admin.css" />
</head>
<body>
  <!-- Login overlay -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="login-card">
      <h2>Acceso al Panel</h2>
      <p class="small">Ingresa tu usuario y contraseÃ±a de administrador.</p>
      <div style="margin-top:14px">
        <input id="loginUser" class="input" placeholder="Usuario" autocomplete="username" />
        <input id="loginPass" class="input" placeholder="ContraseÃ±a" type="password" autocomplete="current-password" />
        <div class="row">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn" id="btnClearSession" title="Borra token local">Limpiar sesiÃ³n</button>
        </div>
        <div id="loginError" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>ğŸ›ï¸ Panel de AdministraciÃ³n Â· INDARELÃN</h1>
    <div class="user-info">
      <span>ğŸ‘¤ <strong id="whoUser">â€”</strong></span>
      <span class="badge-pill">ğŸ”° <span id="whoRole">â€”</span></span>
      <button class="btn btn-ghost" id="btnLogout">Cerrar sesiÃ³n</button>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar" id="navbar">
    <button data-tab="dashboard" class="active">ğŸ“Š Dashboard</button>
    <button data-tab="ips">ğŸŒ IPs</button>
    <button data-tab="ipHistory">ğŸ“œ Historial IP</button>
    <button data-tab="messages">ğŸ’¬ Mensajes</button>
    <button data-tab="custom">âœ¨ Respuestas</button>
    <button data-tab="videos">ğŸ¥ Videos</button>
    <button data-tab="users">ğŸ‘¥ Usuarios</button>
    <button data-tab="security">ğŸ”’ Seguridad</button>
    <button data-tab="profile">ğŸ‘¤ Mi Perfil</button>
  </nav>

  <div class="container">
    <!-- Dashboard -->
    <section id="dashboard" class="tab-content fade">
      <div class="grid stats-grid">
        <div class="stat-card"><h3>Total mensajes</h3><div class="number" id="totalMessages">0</div></div>
        <div class="stat-card"><h3>Total IPs</h3><div class="number" id="totalIPs">0</div></div>
        <div class="stat-card"><h3>Mensajes hoy</h3><div class="number" id="todayMessages">0</div></div>
      </div>

      <div class="card">
        <div class="toolbar">
          <h2>TrÃ¡fico</h2>
          <div class="row">
            <select id="trafficRange" class="input" style="min-width:180px;margin-bottom:0">
              <option value="7">Ãšltimos 7 dÃ­as</option>
              <option value="14">Ãšltimos 14 dÃ­as</option>
              <option value="30">Ãšltimos 30 dÃ­as</option>
            </select>
            <button class="btn primary" id="btnReloadTraffic">Recargar</button>
          </div>
        </div>
        <canvas id="trafficChart"></canvas>
        <div class="hint">Fuente: /metrics/range</div>
      </div>
    </section>

    <!-- IPs -->
    <section id="ips" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>IPs (mapa + tabla)</h2>
          <button class="btn primary" id="btnReloadIps">Recargar</button>
        </div>
        <div id="map"></div>
        <div style="height:14px"></div>
        <table>
          <thead><tr><th>IP</th><th>Total</th><th>Ãšltima vez</th><th>Ciudad</th><th>PaÃ­s</th><th>Acciones</th></tr></thead>
          <tbody id="ipTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Historial por IP -->
    <section id="ipHistory" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>Historial por IP</h2>
        </div>
        <input type="text" id="ipSearch" class="input" placeholder="Ej: 187.210.0.1" />
        <button class="btn primary" id="btnSearchIpHistory">Buscar</button>
        <div id="ipHistoryBox" style="margin-top:14px"></div>
      </div>
    </section>

    <!-- Mensajes -->
    <section id="messages" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>Historial general</h2>
          <div class="row">
            <button class="btn" id="btnExportMessagesCsv">Exportar CSV</button>
            <button class="btn" id="btnExportMessagesXlsx">Exportar XLSX</button>
            <button class="btn primary" id="btnReloadMessages">Recargar</button>
          </div>
        </div>
        <table>
          <thead><tr><th>IP</th><th>Rol</th><th>Mensaje</th><th>Fecha</th></tr></thead>
          <tbody id="generalHistory"></tbody>
        </table>
      </div>
    </section>

    <!-- Respuestas -->
    <section id="custom" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>Respuestas personalizadas</h2>
          <div class="row">
            <button class="btn" id="btnCustomTemplate">Plantilla XLSX</button>
            <button class="btn" id="btnCustomExportCsv">Exportar CSV</button>
            <button class="btn" id="btnCustomExportPdf">Exportar PDF</button>
          </div>
        </div>

        <div id="permHint" class="hint"></div>

        <input type="hidden" id="customId" />
        <input type="text" id="triggerInput" class="input" placeholder="Trigger / pregunta" />
        <textarea id="responseInput" class="input" rows="4" placeholder="Respuesta"></textarea>
        <input type="text" id="keywordsInput" class="input" placeholder="Keywords (coma separada)" />
        <input type="number" id="priorityInput" class="input" placeholder="Prioridad" value="10" />
        <select id="typeInput" class="input">
          <option value="text">Texto</option>
          <option value="video">Video</option>
        </select>
        <label class="small"><input type="checkbox" id="enabledInput" checked /> Activo</label>

        <div id="videoBox" class="hidden" style="margin-top:12px">
          <select id="videoSelect" class="input"></select>
          <input type="text" id="videoUrlInput" class="input" placeholder="o pega URL externa" />
          <div id="videoPreview"></div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveCustom">Guardar</button>
          <button class="btn" id="btnNewCustom">Nuevo</button>
          <button class="btn danger hidden" id="btnDeleteCustom">Eliminar</button>
        </div>

        <hr />
        <input type="text" id="customSearch" class="input" placeholder="Buscar..." />
        <table>
          <thead><tr><th>Trigger</th><th>Tipo</th><th>Prioridad</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="customTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Videos -->
    <section id="videos" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>Biblioteca de videos</h2>
          <button class="btn primary" id="btnReloadVideos">Recargar</button>
        </div>

        <input type="file" id="videoFile" accept="video/*" class="input" />
        <button class="btn primary" id="btnUploadVideo">Subir video</button>

        <div id="videoLibraryPreview" style="margin:14px 0"></div>

        <table>
          <thead><tr><th>Nombre</th><th>Fecha</th><th>Acciones</th></tr></thead>
          <tbody id="videosTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Usuarios -->
    <section id="users" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>Usuarios admin</h2>
          <button class="btn primary" id="btnReloadUsers">Recargar</button>
        </div>
        <div id="usersPermHint" class="hint"></div>

        <h3 style="margin:10px 0">Crear usuario</h3>
        <input type="text" id="newUsername" class="input" placeholder="Usuario" />
        <input type="password" id="newPassword" class="input" placeholder="ContraseÃ±a" />
        <select id="newRole" class="input">
          <option value="support">Support</option>
          <option value="analyst">Analyst</option>
          <option value="editor">Editor</option>
          <option value="super">Super</option>
        </select>
        <label class="small"><input type="checkbox" id="newUserActive" checked /> Activo</label>
        <button class="btn primary" id="btnCreateUser">Crear</button>

        <hr />
        <table>
          <thead><tr><th>Usuario</th><th>Rol</th><th>Estado</th><th>Creado</th><th>Actualizado</th><th>Acciones</th></tr></thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Seguridad -->
    <section id="security" class="tab-content hidden fade">
      <div class="card">
        <h2>IPs bloqueadas</h2>
        <div class="row">
          <input type="text" id="blockIpValue" class="input" placeholder="IP a bloquear" style="flex:1" />
          <input type="text" id="blockIpReason" class="input" placeholder="RazÃ³n" style="flex:2" />
        </div>
        <button class="btn danger" id="btnBlockIp">Bloquear IP</button>

        <table style="margin-top:14px">
          <thead><tr><th>IP</th><th>Estado</th><th>RazÃ³n</th><th>Fecha</th><th>Acciones</th></tr></thead>
          <tbody id="blockedIPsTable"></tbody>
        </table>
      </div>

      <div class="card">
        <h2>ConfiguraciÃ³n IA</h2>
        <label class="small">LÃ­mite diario de mensajes IA por IP (0 = sin lÃ­mite)</label>
        <input type="number" id="aiLimitPerIp" class="input" placeholder="0" />
        <button class="btn primary" id="btnSaveAiLimit">Guardar</button>
      </div>
    </section>

    <!-- Perfil -->
    <section id="profile" class="tab-content hidden fade">
      <div class="card">
        <div class="toolbar">
          <h2>Mi perfil</h2>
          <button class="btn primary" id="btnReloadProfile">Recargar</button>
        </div>
        <div id="profileBox" class="small"></div>

        <hr />
        <h3 style="margin:10px 0">Cambiar contraseÃ±a</h3>
        <input type="password" id="myCurrentPassword" class="input" placeholder="ContraseÃ±a actual" />
        <input type="password" id="myNewPassword" class="input" placeholder="Nueva contraseÃ±a" />
        <button class="btn primary" id="btnChangeMyPassword">Cambiar contraseÃ±a</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module" src="/admin-app/js/main.js"></script>
</body>
</html>
