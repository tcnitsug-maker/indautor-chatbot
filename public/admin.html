<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Panel Administrativo INDARELÃN</title>

<link rel="stylesheet" href="admin.css" />

<!-- LEAFLET MAP -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- CHART JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<header class="topbar">
  <div class="brand">
    <div class="logo">INDARELÃN</div>
    <div class="title">Panel Administrativo</div>
  </div>
  <div class="who">
    <span id="whoUser" class="who-user">â€”</span>
    <span id="whoRole" class="who-role badge">â€”</span>
    <button class="btn" onclick="logout()">Salir</button>
  </div>
</header>

<div id="navbar">
  <button data-tab="dashboard">ğŸ“ˆ Dashboard</button>
  <button data-tab="ips">ğŸŒ IPs & GeolocalizaciÃ³n</button>
  <button data-tab="security">ğŸ”’ Seguridad (IPs)</button>
  <button data-tab="ipHistory">ğŸ“œ Historial por IP</button>
  <button data-tab="messages">ğŸ’¬ Historial General</button>
  <button data-tab="custom">ğŸ§  Respuestas</button>
  <button data-tab="videos">ğŸ¥ Videos</button>
  <button data-tab="users">ğŸ‘¤ Usuarios</button>
  <button data-tab="profile">âš™ï¸ Mi perfil</button>
</div>

<main>

  <!-- DASHBOARD -->
  <section id="dashboard" class="tab-content active">
    <h2>ğŸ“Š Dashboard General</h2>

    <div class="cards">

      <div class="card">
        <h3>Total Mensajes</h3>
        <p id="totalMessages">0</p>
      </div>

      <div class="card">
        <h3>Total IPs Ãšnicas</h3>
        <p id="totalIPs">0</p>
      </div>

      <div class="card">
        <h3>Consultas Hoy</h3>
        <p id="todayMessages">0</p>
      </div>

    </div>

    <canvas id="trafficChart"></canvas>
  </section>

  <!-- IP LIST -->
  <section id="ips" class="tab-content">
    <h2>ğŸŒ IPs Conectadas</h2>
    <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Mensajes</th>
          <th>Ãšltima vez</th>
          <th>Ciudad</th>
          <th>PaÃ­s</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="ipTable"></tbody>
    </table>
  </section>
  <!-- SECURITY: BLOCKED IPS + IA LIMIT -->
  <section id="security" class="tab-content">
    <h2>ğŸ”’ Seguridad</h2>

    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <h3>IPs bloqueadas</h3>
          <div class="actions">
            <button class="btn" onclick="loadBlockedIPs()">ğŸ”„ Recargar</button>
            <button class="btn secondary" onclick="exportBlockedIPsXLSX()">â¬‡ï¸ Exportar Excel</button>
          </div>
        </div>

        <div class="form inline">
          <input id="blockIpValue" class="input" placeholder="IP (ej: 187.210.10.10)" />
          <input id="blockIpReason" class="input" placeholder="Motivo (opcional)" />
          <button class="btn danger" onclick="blockIP()">Bloquear</button>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>IP</th>
              <th>Estado</th>
              <th>Motivo</th>
              <th>Actualizado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="blockedIPsTable"></tbody>
        </table>

        <div class="hint">Solo <b>super</b> puede bloquear / desbloquear IPs.</div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3>LÃ­mite diario de IA (por IP)</h3>
          <div class="actions">
            <button class="btn" onclick="loadSettings()">ğŸ”„ Cargar</button>
          </div>
        </div>

        <div class="form">
          <label>LÃ­mite de consultas IA por dÃ­a (0 = sin lÃ­mite)</label>
          <input id="aiLimitPerIp" class="input" type="number" min="0" max="10000" placeholder="Ej: 20" />
          <button class="btn" onclick="saveAiLimit()">Guardar</button>
          <div class="hint">Este lÃ­mite aplica <b>solo</b> cuando el chatbot usa IA (Gemini/OpenAI). Las respuestas personalizadas no cuentan.</div>
        </div>
      </div>
    </div>
  </section>


  <!-- IP HISTORY -->
  <section id="ipHistory" class="tab-content">
    <h2>ğŸ“œ Historial por IP</h2>
    <input type="text" placeholder="Escribe IP..." id="ipSearch" />
    <button onclick="loadIPHistory()">Buscar</button>
    <div id="ipHistoryBox"></div>
  </section>

  <!-- ORIGINAL MESSAGE HISTORY -->
  <section id="messages" class="tab-content">
    <h2>ğŸ’¬ Historial General</h2>
    <table>
      <thead>
        <tr><th>Rol</th><th>Mensaje</th><th>Fecha</th></tr>
      </thead>
      <tbody id="generalHistory"></tbody>
    </table>
  </section>

  <!-- CUSTOM REPLIES (OLD PANEL) -->
  
<section id="custom" class="tab-content">
  <h2>ğŸ§  Respuestas Personalizadas</h2>

  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn" onclick="downloadCustomTemplate()">â¬‡ï¸ Plantilla Excel</button>
      <label class="btn" style="cursor:pointer;">
        ğŸ“¤ Importar Excel/CSV
        <input id="customImportFile" type="file" accept=".xlsx,.xls,.csv" style="display:none" onchange="importCustomReplies()" />
      </label>
      <span class="muted">(Se crea/actualiza por trigger)</span>
    </div>
    <div class="toolbar-right">
      <button class="btn" onclick="downloadCustomCSV()">â¬‡ï¸ Exportar CSV</button>
      <button class="btn" onclick="downloadCustomPDF()">â¬‡ï¸ Exportar PDF</button>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-header">
        <h3>Lista</h3>
        <input id="customSearch" class="input" placeholder="Buscar trigger o keyword..." />
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Trigger</th>
            <th>Tipo</th>
            <th>Prioridad</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="customTable"></tbody>
      </table>

      <div class="hint">
        * Las respuestas se evalÃºan por <b>prioridad</b> (mayor primero).
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h3 id="customFormTitle">Crear / Editar</h3>
        <div class="row">
          <button id="btnNewCustom" class="btn" onclick="newCustom()">â• Nuevo</button>
        </div>
      </div>

      <div class="form">
        <input type="hidden" id="customId" />
        <label>Trigger (pregunta clave)</label>
        <input id="triggerInput" class="input" placeholder="Ej: horario, requisitos, etc." />

        <label>Respuesta (texto)</label>
        <textarea id="responseInput" class="textarea" placeholder="Escribe la respuesta..."></textarea>

        <div class="row">
          <div>
            <label>Palabras clave (separadas por coma)</label>
            <input id="keywordsInput" class="input" placeholder="ej: costo, precio, pago" />
          </div>
          <div>
            <label>Prioridad</label>
            <input id="priorityInput" class="input" type="number" min="1" max="100" value="10" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Tipo</label>
            <select id="typeInput" class="input" onchange="onTypeChange()">
              <option value="text">Texto</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div class="switch">
            <label><input type="checkbox" id="enabledInput" checked /> Activo</label>
          </div>
        </div>

        <div id="videoBox" class="video-box hidden">
          <div class="row">
            <div>
              <label>Video (subido)</label>
              <select id="videoSelect" class="input"></select>
              <small>Tip: sube videos en la pestaÃ±a ğŸ¥ Videos.</small>
            </div>
            <div>
              <label>O URL externa (YouTube embed)</label>
              <input id="videoUrlInput" class="input" placeholder="https://www.youtube.com/embed/XXXX" />
            </div>
          </div>

          <div class="preview">
            <div id="videoPreview"></div>
          </div>
        </div>
        <div class="preview-box">
  <h3>ğŸ¤– Vista previa del bot</h3>

  <div class="preview-meta">
    <span id="previewType">Tipo: â€”</span>
    <span id="previewPriority">Prioridad: â€”</span>
    <span id="previewStatus">Estado: â€”</span>
  </div>

  <div id="previewContent" class="preview-content">
    <em>Escribe una respuesta para ver la vista previaâ€¦</em>
  </div>
</div>

        <div class="row">
          <button class="btn primary" onclick="saveCustom()">ğŸ’¾ Guardar</button>
          <button class="btn danger" id="btnDeleteCustom" onclick="deleteCustom()" style="display:none;">ğŸ—‘ï¸ Eliminar</button>
        </div>

        <div class="hint" id="permHint"></div>
      </div>
    </div>
  </div>
</section>

  <!-- USERS (ADMIN USERS) -->
  <section id="users" class="tab-content">
    <h2>ğŸ‘¤ Usuarios (Administradores)</h2>
    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <h3>Lista de usuarios</h3>
          <button class="btn" onclick="loadUsers()">ğŸ”„ Recargar</button>
          <button class="btn" onclick="scrollToCreateUser()">â• Agregar usuario</button>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Activo</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
        <div class="hint" id="usersPermHint"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3>Crear usuario</h3>
        </div>
        <div class="form">
          <label>Usuario</label>
          <input id="newUserUsername" class="input" placeholder="ej: soporte1" />
          <label>ContraseÃ±a</label>
          <input id="newUserPassword" class="input" type="password" placeholder="mÃ­nimo 6" />
          <div class="row">
            <div>
              <label>Rol</label>
              <select id="newUserRole" class="input">
                <option value="support">support (bÃ¡sico)</option>
                <option value="analyst">analyst (lectura)</option>
                <option value="editor">editor (edita respuestas)</option>
                <option value="super">super (todo)</option>
              </select>
            </div>
            <div class="switch">
              <label><input type="checkbox" id="newUserActive" checked /> Activo</label>
            </div>
          </div>
          <button class="btn primary" onclick="createUser()">â• Crear</button>
          <div class="hint">* Solo rol <b>super</b> puede administrar usuarios.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="tab-content">
    <h2>âš™ï¸ Mi perfil</h2>
    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <h3>Datos</h3>
          <button class="btn" onclick="loadProfile()">ğŸ”„ Recargar</button>
        </div>
        <div class="hint" id="profileBox">â€”</div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3>Cambiar contraseÃ±a</h3>
        </div>
        <div class="form">
          <label>ContraseÃ±a actual</label>
          <input id="myCurrentPassword" class="input" type="password" />
          <label>Nueva contraseÃ±a</label>
          <input id="myNewPassword" class="input" type="password" />
          <button class="btn primary" onclick="changeMyPassword()">Guardar</button>
          <div class="hint">* MÃ­nimo 6 caracteres.</div>
        </div>
      </div>
    </div>
  </section>



  <section id="videos" class="tab-content">
    <h2>ğŸ¥ Biblioteca de Videos</h2>

    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <h3>Subir video (MP4/WebM, mÃ¡x 50MB)</h3>
        </div>

        <div class="form">
          <input type="file" id="videoFile" accept="video/mp4,video/webm,video/ogg" class="input" />
          <button class="btn primary" onclick="uploadVideo()">â¬†ï¸ Subir</button>
          <div class="hint">Los roles <b>editor</b> y <b>super</b> pueden subir. Solo <b>super</b> puede eliminar.</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3>Videos subidos</h3>
        </div>
        <table class="table">
          <thead>
            <tr><th>Nombre</th><th>Fecha</th><th>Acciones</th></tr>
          </thead>
          <tbody id="videosTable"></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header"><h3>Vista previa</h3></div>
      <div id="videoLibraryPreview" class="preview"></div>
    </div>
  </section>

</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="admin.js"></script>

</body>
</html>
