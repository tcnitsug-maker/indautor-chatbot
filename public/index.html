<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Asistente INDAREL√çN</title>

<style>
body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:#f2f2f2}

/* BOT√ìN */
#chatBtn{
  position:fixed;right:20px;bottom:20px;width:64px;height:64px;border-radius:50%;
  background:#075e54;color:#fff;border:none;font-size:26px;cursor:pointer;
  box-shadow:0 8px 20px rgba(0,0,0,.35);z-index:9999;
}

/* CHAT */
#chatBox{
  position:fixed;right:20px;bottom:100px;width:380px;max-height:600px;
  background:#e5ddd5;border-radius:14px;display:none;flex-direction:column;
  overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:9999;
}

/* HEADER */
#chatHeader{
  background:#075e54;color:#fff;padding:10px;font-weight:600;
  display:flex;align-items:center;justify-content:space-between;
}
.langSelect{border-radius:12px;border:none;padding:4px}

/* FAQ */
#quickFaq{
  display:flex;gap:6px;flex-wrap:wrap;padding:8px;background:#f7f7f7;
  border-bottom:1px solid rgba(0,0,0,.1);
}
#quickFaq button{
  border:none;background:#e0e0e0;padding:6px 10px;border-radius:14px;
  font-size:12px;cursor:pointer;
}

/* MENSAJES */
#chatMessages{
  flex:1;padding:12px;overflow-y:auto;
}
.msg{
  max-width:82%;padding:8px 12px;margin-bottom:8px;border-radius:12px;
  font-size:14px;white-space:pre-wrap;line-height:1.35;
}
.user{background:#dcf8c6;margin-left:auto}
.bot{background:#fff;margin-right:auto}
.sys{background:#fff3cd;margin:0 auto;font-size:12px}

/* VIDEO */
.msg video,.msg iframe{width:100%;margin-top:8px;border-radius:10px}

/* PAGINACI√ìN */
.navBtns{display:flex;gap:6px;margin-top:6px}
.navBtns button{
  flex:1;border:none;background:#075e54;color:#fff;padding:6px;
  font-size:12px;border-radius:8px;cursor:pointer;
}

/* INPUT */
#chatInputBox{
  display:flex;gap:8px;background:#f0f0f0;border-top:1px solid #ccc;
  padding:8px;
}
#chatInput{
  flex:1;border:none;padding:10px;font-size:14px;border-radius:12px;
}
#sendBtn,#micBtn{
  border:none;background:#075e54;color:#fff;border-radius:12px;
  width:44px;height:44px;font-size:18px;cursor:pointer;
}
#micBtn.rec{background:#b00020}
</style>
</head>

<body>

<button id="chatBtn">üí¨</button>

<div id="chatBox">
  <div id="chatHeader">
    <span id="chatTitle">Asistente INDAREL√çN</span>
    <select id="langSelect" class="langSelect">
      <option value="es">ES</option>
      <option value="en">EN</option>
    </select>
  </div>

  <div id="quickFaq"></div>
  <div id="chatMessages"></div>

  <div id="chatInputBox">
    <button id="micBtn">üéô</button>
    <input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶">
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "/chat";
const SESSION_KEY = "indarelin_session";

/* ================= I18N ================= */
const I18N = {
  es:{
    title:"Asistente INDAREL√çN",
    placeholder:"Escribe tu mensaje‚Ä¶",
    typing:"Escribiendo‚Ä¶",
    unavailable:"Servicio no disponible.",
    faq:[
      {label:"Registro",text:"¬øC√≥mo me registro en INDAREL√çN?"},
      {label:"Requisitos",text:"¬øCu√°les son los requisitos?"},
      {label:"Costos",text:"¬øCu√°nto cuesta el tr√°mite?"}
    ],
    welcome:"Hola üëã ¬øEn qu√© puedo ayudarte?"
  },
  en:{
    title:"INDAREL√çN Assistant",
    placeholder:"Type your message‚Ä¶",
    typing:"Typing‚Ä¶",
    unavailable:"Service unavailable.",
    faq:[
      {label:"Sign up",text:"How do I sign up?"},
      {label:"Requirements",text:"What are the requirements?"},
      {label:"Costs",text:"How much does it cost?"}
    ],
    welcome:"Hi üëã How can I help you?"
  }
};

let LANG = localStorage.getItem("chat_lang") || "es";

/* ================= DOM ================= */
const chatBtn = document.getElementById("chatBtn");
const chatBox = document.getElementById("chatBox");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const langSelect = document.getElementById("langSelect");
const chatTitle = document.getElementById("chatTitle");
const quickFaq = document.getElementById("quickFaq");

/* ================= SESSION ================= */
function loadSession(){
  try{return JSON.parse(sessionStorage.getItem(SESSION_KEY)||"[]")}catch{return[]}
}
function saveSession(s){sessionStorage.setItem(SESSION_KEY,JSON.stringify(s.slice(-50)))}
let session = loadSession();

/* ================= UI ================= */
function addMsg(text,cls,video=null,save=true){
  const d=document.createElement("div");
  d.className="msg "+cls;

  const MAX=520;
  if(cls==="bot"&&text.length>MAX){
    let p=0,pages=[];
    for(let i=0;i<text.length;i+=MAX)pages.push(text.slice(i,i+MAX));
    const c=document.createElement("div");
    c.textContent=pages[p];
    const nav=document.createElement("div");
    nav.className="navBtns";
    const b1=document.createElement("button");
    const b2=document.createElement("button");
    b1.textContent="‚¨Ö";
    b2.textContent="‚û°";
    b1.onclick=()=>{if(p>0){p--;c.textContent=pages[p]}};
    b2.onclick=()=>{if(p<pages.length-1){p++;c.textContent=pages[p]}};
    nav.append(b1,b2);
    d.append(c,nav);
  }else d.textContent=text;

  if(video){
    if(video.includes("youtube")){
      const i=document.createElement("iframe");
      i.src=video;i.allowFullscreen=true;
      d.appendChild(i);
    }else{
      const v=document.createElement("video");
      v.src=video;v.controls=true;
      d.appendChild(v);
    }
  }

  chatMessages.appendChild(d);
  chatMessages.scrollTop=chatMessages.scrollHeight;

  if(save){
    session.push({role:cls,text,video});
    saveSession(session);
  }
}

function renderFAQ(){
  quickFaq.innerHTML="";
  I18N[LANG].faq.forEach(f=>{
    const b=document.createElement("button");
    b.textContent=f.label;
    b.onclick=()=>{chatInput.value=f.text;send()};
    quickFaq.appendChild(b);
  });
}

function applyLang(){
  chatTitle.textContent=I18N[LANG].title;
  chatInput.placeholder=I18N[LANG].placeholder;
  langSelect.value=LANG;
  localStorage.setItem("chat_lang",LANG);
  renderFAQ();
}

/* ================= VOZ ================= */
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
let rec=null,recOn=false;
micBtn.onclick=()=>{
  if(!SR)return;
  if(recOn){rec.stop();return;}
  rec=new SR();
  rec.lang=LANG==="en"?"en-US":"es-MX";
  recOn=true;micBtn.classList.add("rec");
  rec.onresult=e=>chatInput.value=e.results[0][0].transcript;
  rec.onend=()=>{recOn=false;micBtn.classList.remove("rec");send()};
  rec.start();
};

/* ================= SEND ================= */
async function send(){
  const msg=chatInput.value.trim();
  if(!msg)return;
  chatInput.value="";
  addMsg(msg,"user");
  addMsg(I18N[LANG].typing,"sys",null,false);

  const history=session
    .filter(x=>x.role==="user"||x.role==="bot")
    .slice(-12)
    .map(x=>({role:x.role==="bot"?"assistant":"user",content:x.text}));

  try{
    const r=await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:msg,lang:LANG,history})
    });
    const d=await r.json();
    chatMessages.lastChild.remove();
    addMsg(d.reply||"","bot",d.videoUrl||null);
  }catch{
    chatMessages.lastChild.remove();
    addMsg(I18N[LANG].unavailable,"bot");
  }
}

/* ================= INIT ================= */
chatBtn.onclick=()=>chatBox.style.display=chatBox.style.display==="flex"?"none":"flex";
sendBtn.onclick=send;
chatInput.onkeydown=e=>{if(e.key==="Enter")send()};
langSelect.onchange=()=>{LANG=langSelect.value;applyLang()};

applyLang();
if(!session.length)addMsg(I18N[LANG].welcome,"sys");
else session.forEach(m=>addMsg(m.text,m.role,m.video,false));
</script>

</body>
</html>
